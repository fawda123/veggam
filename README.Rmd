---
title: "README"
output: 
  html_document:
    keep_md: yes
author: "Marcus W. Beck, beck.marcus@epa.gov, Janne Alahuhta, Janne.Alahuhta@oulu.fi"
---

### Files

* `ecoregs.RData` SpatialPolygonsDataFrame for MN ecoregions
* `mncounties.RData` SpatialPolygonsDataFrame for MN counties
* `mnstate.RData` SpatialPolygonsDataFrame for state outline
* `veg_dat.RData` DNR vegetation transect data from 1992 to 2014, created in `fishveg.RProj`, combination of nrri processed data, current transect data, and gaps filled with another file
* `veg_rch.RData` Summarized vegetation richness data from veg_dat, includes total richness (`richtot`), submersed species richness (`richsub`), presence/absence of coontail (as 1/0, `cd_pres`), presence/absence of curly-leaf (`pc_pres`), presence/absence of milfoil (`ms_pres`), and richness of native submersed species (`richnat`). Scientific names were manually verified during processing to remove duplicates (all species had scientific names except 'filamentous algae', 'planktonic algae', and 'Fern group', these were removed - 2642 records out of 894920 ~0.3% of total)

### Model examples

#### Exploratory analysis

Maps showing speices richness of pecies richness of submersed macrophytes from MNDNR transect database (top) and presence/absence of the invasives M. spicatum and P. crispus (bottom).
```{r fig.height = 7, fig.width = 7, echo = F, fig.cap = 'Species richness of submersed macrophytes from MNDNR transect database.', message = F, cache = T, warning = F}
library(ggplot2)
library(maptools)
library(gridExtra)
library(RColorBrewer)
library(dplyr) 

# raw veg, spatial data
data(veg_rch)
data(ecoregs)
data(mncounties)
data(mnstate)

# prep spatial data
mnstate <- fortify(mnstate)
ecoregs <- fortify(ecoregs)
mncounties <- fortify(mncounties)
ecoregs$Ecoregion <- factor(ecoregs$id, levels = c(6, 2, 5, 0, 4, 3, 1), # ided from arcmap
  labels = c('DA', 'LAP', 'NCHF', 'NGP', 'NLF', 'NMW', 'WCBP')
)

# subm rich as factor
toplo <- veg_rch %>% 
   mutate(richsub = cut(richsub, breaks = c(-Inf, 5, 10, 15, 20, Inf), 
    labels = c('<5', '<10', '<15', '<20', '>20'))
    ) %>% 
  data.frame
labs <- list(expression(phantom('')<=5), expression(phantom('')<=10), expression(phantom('')<=15), expression(phantom('')<=20), expression(phantom('')>20))

# base map for plots
pbase <- ggplot(mncounties, aes(x = long, y = lat)) + 
  geom_polygon(aes(group = group), fill = NA, colour = 'grey') +
  geom_polygon(data = mnstate, aes(x = long, y = lat), fill = NA, colour = 'black') + 
  geom_polygon(data = ecoregs, aes(x = long, y = lat, group = group, fill= Ecoregion),  
    alpha = 0.5) +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
    axis.text.y=element_blank(),axis.ticks=element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    panel.background=element_blank(),panel.border=element_blank(),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),plot.background=element_blank(), 
    legend.box.just = 'right'
    ) +
  coord_equal()

# add richness data to plot
pbase + 
  geom_point(data = toplo, aes(x = utmx, y = utmy, 
    size = richsub), fill = 'white', colour = 'black', alpha = 0.8, shape = 21, stroke = 1) +
  scale_size_discrete('Richness', range = c(1, 8), labels = labs) +
  scale_fill_manual(values = brewer.pal(9, 'Spectral')[c(1, 2, 3, 5, 7, 8, 9)])
```
```{r fig.cap = 'Distribuion of lakes with P. crispus, M. spicatum, both, or none.', message = F, cache = T, warning = F, message = F,fig.height = 7, fig.width = 7, echo = F}
# p/a of invasives as facet map
pbase + 
  geom_point(data = toplo, aes(x = utmx, y = utmy, shape = Invasive), fill = 'white', size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(21, 22, 23, 24)) + 
  facet_wrap(~Invasive) +
  scale_fill_manual(values = brewer.pal(9, 'Spectral')[c(1, 2, 3, 5, 7, 8, 9)])

```



```{r eval = F}
library(mgcv)
data(veg_rch)

# add covariate data
covdat <- read.table('ignore/MNDNRwatersheds.txt', sep = ',', header = T)

dat <- mutate(veg_rch, DOWNUM = as.integer(gsub('[0-9][0-9]$', '', dow))) %>% 
  left_join(., covdat, by = 'DOWNUM') %>% 
  select(dow, date, richtot, richsub, cd_pres, pc_pres, ms_pres, richnat, depthft, LKACRES, MeanTotalP, secchi, alkalinity) %>% 
  # unite('facs', cd_pres, pc_pres, ms_pres, sep = '') %>% 
  unite('facs', pc_pres, ms_pres, sep = '') %>% 
  mutate(facs = factor(facs, 
    levels = c('00', '10', '01', '11'), 
    labels = c('none', 'pc', 'ms', 'all')
    # labels = c('none', 'cd', 'pc', 'ms', 'cd, pc', 'pc, ms', 'cd, ms', 'all')
    )
  )

tmp2 <- gam(log(1 + richnat) ~ te(log(LKACRES), log(1 + MeanTotalP), by = facs, bs = c("tp", "tp")), data = dat)
tmp1 <- gam(log(1 + richnat) ~ te(log(LKACRES), log(1 + MeanTotalP), bs = c("tp", "tp")), data = dat)
# select one survey date per lake, or use gamm
# setup logit model for individual species

```



### To Do

* Create combined veg transect dataset with covariates from Cross paper
* Check with Cross to see if we can use the dataset
* Run simple GAM looking at effect of curly-leaf, milfoil, and coontail on ind species, fixed and interactions (tensor product)
* a block design (lakes w/ and w/o invasives, etc.)